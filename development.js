angular.module('main', ['sw.table', 'ngResource', 'ngMockE2E'])
    .constant('mockData', [
        {
            "Share":0.49505921646710066,
            "Page":"cnn.com",
            "Children":[
                {
                    "Share":0.31085572508628351,
                    "Page":"cnn.com",
                    "Children":null
                },
                {
                    "Share":0.18197531623601157,
                    "Page":"cnn.com/?refresh=1",
                    "Children":null
                },
                {
                    "Share":0.0010941440294400316,
                    "Page":"cnn.com/?zipCode=&mode",
                    "Children":null
                },
                {
                    "Share":0.00099289807378614221,
                    "Page":"cnn.com/?hpt=sitenav",
                    "Children":null
                },
                {
                    "Share":7.8666197242021959E-05,
                    "Page":"cnn.com/?eref=rss_topstories",
                    "Children":null
                },
                {
                    "Share":6.2466844337399661E-05,
                    "Page":"cnn.com/?sr=bleacher_backtocnn",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.099408322455760756,
            "Page":"edition.cnn.com",
            "Children":[
                {
                    "Share":0.054595601684656291,
                    "Page":"edition.cnn.com",
                    "Children":null
                },
                {
                    "Share":0.043934135112154729,
                    "Page":"edition.cnn.com/?refresh=1",
                    "Children":null
                },
                {
                    "Share":0.00048128124655548844,
                    "Page":"edition.cnn.com/?hpt=header_edition-picker",
                    "Children":null
                },
                {
                    "Share":0.00039730441239426247,
                    "Page":"edition.cnn.com/?hpt=ed_Intl",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.01942099921352906,
            "Page":"money.cnn.com/data/markets",
            "Children":[
                {
                    "Share":0.018697529999845267,
                    "Page":"money.cnn.com/data/markets",
                    "Children":null
                },
                {
                    "Share":0.00059960529359703385,
                    "Page":"money.cnn.com/data/markets/?iid=C_All_MKTS",
                    "Children":null
                },
                {
                    "Share":0.00012386392008675824,
                    "Page":"money.cnn.com/data/markets/?iid=intnledition",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.014021036617223618,
            "Page":"money.cnn.com",
            "Children":[
                {
                    "Share":0.013875891943439042,
                    "Page":"money.cnn.com",
                    "Children":null
                },
                {
                    "Share":0.00014514467378457573,
                    "Page":"money.cnn.com/?hpt=sitenav",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.0091546975162456763,
            "Page":"money.cnn.com/data/premarket",
            "Children":[
                {
                    "Share":0.0064534172133789078,
                    "Page":"money.cnn.com/data/premarket",
                    "Children":null
                },
                {
                    "Share":0.002362774956793766,
                    "Page":"money.cnn.com/data/premarket/?iid=H_MKT_QL",
                    "Children":null
                },
                {
                    "Share":0.00026350692684712265,
                    "Page":"money.cnn.com/data/premarket/?iid=A_MKT_QL",
                    "Children":null
                },
                {
                    "Share":7.4998419225881063E-05,
                    "Page":"money.cnn.com/data/premarket/?iid=MKT_Sub",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.0070525258287029227,
            "Page":"cnn.com/us",
            "Children":null
        },
        {
            "Share":0.0057952802956076259,
            "Page":"us.cnn.com",
            "Children":[
                {
                    "Share":0.0021602448394649858,
                    "Page":"us.cnn.com/?refresh=1",
                    "Children":null
                },
                {
                    "Share":0.0013499333400448577,
                    "Page":"us.cnn.com",
                    "Children":null
                },
                {
                    "Share":0.0011422072038598779,
                    "Page":"us.cnn.com/?hpt=header_edition-picker",
                    "Children":null
                },
                {
                    "Share":0.00095362228419663335,
                    "Page":"us.cnn.com/?hpt=ed_US",
                    "Children":null
                },
                {
                    "Share":0.00018927262804127091,
                    "Page":"us.cnn.com/?cnn_shwEDDH=1",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.0048809720070215031,
            "Page":"arabic.cnn.com",
            "Children":[
                {
                    "Share":0.0048623656747937881,
                    "Page":"arabic.cnn.com",
                    "Children":null
                },
                {
                    "Share":1.8606332227714761E-05,
                    "Page":"arabic.cnn.com/?hpt=ed_Arabic",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.00459144677987238,
            "Page":"cnn.com/world",
            "Children":null
        },
        {
            "Share":0.0042569530660045308,
            "Page":"cnn.com/go",
            "Children":[
                {
                    "Share":0.0023741603510522035,
                    "Page":"cnn.com/go",
                    "Children":null
                },
                {
                    "Share":0.0010245708651963588,
                    "Page":"cnn.com/go/?stream=CNN",
                    "Children":null
                },
                {
                    "Share":0.00085822184975596855,
                    "Page":"cnn.com/go/?stream=CNN&hpt=hp_livenow_tve_plyr",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.0033290816399628867,
            "Page":"cnn.com/tech",
            "Children":null
        },
        {
            "Share":0.0026891689942093043,
            "Page":"cnn.com/studentnews",
            "Children":null
        },
        {
            "Share":0.0021106916302260823,
            "Page":"money.cnn.com/data/us_markets",
            "Children":[
                {
                    "Share":0.0018853907243804272,
                    "Page":"money.cnn.com/data/us_markets",
                    "Children":null
                },
                {
                    "Share":0.00022530090584565494,
                    "Page":"money.cnn.com/data/us_markets/?iid=MKT_Sub",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.002100528828639692,
            "Page":"cnnespanol.cnn.com",
            "Children":null
        },
        {
            "Share":0.002081922496411977,
            "Page":"edition.cnn.com/world",
            "Children":null
        },
        {
            "Share":0.001873355827764965,
            "Page":"cnn.com/entertainment",
            "Children":null
        },
        {
            "Share":0.0017021546476573882,
            "Page":"cnn.com/politics",
            "Children":null
        },
        {
            "Share":0.0015365315466160259,
            "Page":"cnn.com/smartlink/index.html",
            "Children":[
                {
                    "Share":0.0015365315466160259,
                    "Page":"cnn.com/smartlink/index.html?showid=&segmentid=&featured=false&section=livetv&subsection=cnn&type=section&defaulturl=http://cnn.com/go&iscnngo=false&debug=false",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.0013435529345376127,
            "Page":"cnn.com/videos",
            "Children":null
        },
        {
            "Share":0.0013205911159157304,
            "Page":"mexico.cnn.com",
            "Children":null
        },
        {
            "Share":0.0011387686619697458,
            "Page":"money.cnn.com/data/afterhours",
            "Children":[
                {
                    "Share":0.00083697930207915256,
                    "Page":"money.cnn.com/data/afterhours",
                    "Children":null
                },
                {
                    "Share":0.00023844377707015981,
                    "Page":"money.cnn.com/data/afterhours/?iid=H_MKT_QL",
                    "Children":null
                },
                {
                    "Share":6.3345582820433419E-05,
                    "Page":"money.cnn.com/data/afterhours/?iid=MKT_Sub",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.00096038474991389314,
            "Page":"edition.cnn.com/videos",
            "Children":null
        },
        {
            "Share":0.00093803422762803461,
            "Page":"edition.cnn.com/us",
            "Children":null
        },
        {
            "Share":0.00092343952760547392,
            "Page":"money.cnn.com/2015/01/20/media/paris-mayor-sue-fox-news/index.html",
            "Children":[
                {
                    "Share":0.00071265690974037677,
                    "Page":"money.cnn.com/2015/01/20/media/paris-mayor-sue-fox-news/index.html?iid=HP_LN",
                    "Children":null
                },
                {
                    "Share":0.00021078261786509721,
                    "Page":"money.cnn.com/2015/01/20/media/paris-mayor-sue-fox-news/index.html",
                    "Children":null
                }
            ]
        },
        {
            "Share":0.00089524348410639082,
            "Page":"cnn.com/health",
            "Children":null
        },
        {
            "Share":0.00086891953563637955,
            "Page":"edition.cnn.com/studentnews",
            "Children":null
        },
        {
            "Share":0.00084347432564940207,
            "Page":"money.cnn.com/data/world_markets/americas",
            "Children":[
                {
                    "Share":0.00052132115656502651,
                    "Page":"money.cnn.com/data/world_markets/americas/?iid=H_MKT_QL",
                    "Children":null
                },
                {
                    "Share":0.00027256175382447045,
                    "Page":"money.cnn.com/data/world_markets/americas",
                    "Children":null
                },
                {
                    "Share":4.9591415259905055E-05,
                    "Page":"money.cnn.com/data/world_markets/americas/?iid=A_MKT_QL",
                    "Children":null
                }
            ]
        }
    ]).filter('percentage', function () {
    return function (val, fraction, unavailable) {
        val = Number(val);

        if (isNaN(val)) {
            return unavailable ? unavailable : '0';
        }

        if (!val && unavailable) {
            return unavailable;
        }

        if (100 > val * 100 && val * 100 > 99.99) {
            return ' > 99.99';
        }

        var zeros = '';
        for (var k = 0; k < fraction - 1; k++) {
            zeros += '0';
        }
        var round = Number('1' + zeros + '0');

        if (0 < val * 100 && val * 100 < 1 / round && val !== 0) {
            var ret = ' < 0.';
            ret += zeros;
            ret += '1';
            return ret;
        }

        val = (Math.round(100 * val * round)) / round;
        val = val.toFixed(fraction);
        return val;
    }
    })
    .run(function($httpBackend, ServerDataModel) {
        var tableData = ServerDataModel.data,
            pageSize = 5;

        $httpBackend.whenGET('/tableData').respond(function(method, url, data) {
            return [200, tableData, {}];
        });
        // must use regex to catch query params due to issue in $httpbackend
        // also the order of query params is important
        $httpBackend.whenGET(/\/tableData\?field/).respond(function(method, url, data) {
            return [200, ServerDataModel.sortData(tableData), {}];
        });
        $httpBackend.whenGET(/\/tableData\?pageSize/).respond(function(method, url, data) {
            return [200, ServerDataModel.loadMoreData(pageSize), {}];
        });
    })
    .service('ServerDataModel', function ServerDataModel(mockData) {
        return {
            data: mockData,
            sortData: function(field, sortDirection){
                // not really sorting, just simulating with a simple reverse
                return this.data.reverse();
            },
            loadMoreData: function(pageSize){
                var data = this.data;
                for (var i = 0; i < pageSize; i++) {
                    var copy = angular.copy(this.data[0]);
                    data.push(copy);
                }
                return data;
            }
        };
    })
    .factory('HttpService', function($http, ServerDataModel) {
        return {
            query: function(params) {
                return $http.get('/tableData', { params: params });
            }
        };
    })
    .controller('mainCtrl', function ($scope, tableService, HttpService) {
        $scope.tableColumns = [
            new tableService.Column({
                field: 'Page',
                displayName: 'URL',
                //cellTemplate: 'templates/app-name.html',
                sortable: true
            }),
            new tableService.Column({
                field: 'Share',
                displayName: 'Traffic Share',
                cellTemplate: 'templates/traffic-share.html',
                sortable: true
            })
        ];
        $scope.tableData = [];
        $scope.queryHttp = function(params) {
            HttpService.query(params)
                .error(function(data, status, headers) {
                    $scope.tableData = data;
                })
                .success(function(data) {
                    $scope.tableData = data;
                });
        };
        $scope.queryHttp();
    });